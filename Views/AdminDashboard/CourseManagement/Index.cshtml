@model AP_Project.Models.Users.Admin
@using System.Globalization
@{
    ViewData["ActiveTab"] = "Course";
    ViewData["Title"] = "داشبورد ادمین";
    Layout = "_LayoutAdmin";

    var sections = ViewBag.Sections as List<AP_Project.Models.Courses.Section>;
    var currentHash = ViewContext.HttpContext.Request.Query["h"].ToString();
    var hasFooter = false;
    var pc = new PersianCalendar();
}

<link rel="stylesheet" href="~/lib/fontawesome/6.7.2/css/all.min.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/AdminDashboard/CourseManagement/course-management.css" asp-append-version="true" />

<main class="dashboard-main admin @(hasFooter ? "has-footer" : "has-not-footer")">
    <div class="toolbar">
        <a asp-controller="CourseManagement" asp-action="AddCourseIndex"
           asp-route-h="@currentHash" class="btn-add-course">
            <span class="icon">&#43;</span>
            <span class="text">افزودن درس</span>
        </a>
    </div>

    <table class="course-table">
        <thead>
            <tr>
                <th class="col-index">ردیف</th>
                <th class="col-title">عنوان درس</th>
                <th class="col-code">کد درس</th>
                <th class="col-units">تعداد واحد</th>
                <th class="col-prereq">کد پیش‌نیاز</th>
                <th class="col-semester">نیم‌سال</th>
                <th class="col-instructor">نام استاد</th>
                <th class="col-schedule">زمان برگزاری</th>
                <th class="col-examdate">تاریخ امتحان</th>
                <th class="col-description">توضیحات</th>
                <th class="col-courseid">آی‌دی درس</th>
                @if (sections != null && sections.Any())
                {
                    <th class="col-actions"></th>
                }
            </tr>
        </thead>

        @if (sections != null && sections.Any())
        {
            <tbody>
                @for (int i = 0; i < sections.Count; i++)
                {
                    var s = sections[i];
                    var course = s.Course;
                    var instructor = s.Teaches?.Instructor;
                    var timeSlot = s.TimeSlot;
                    var prereq = course?.Prerequisites?.FirstOrDefault()?.PrerequisiteCourseCode?.Code.ToString() ?? "-";

                    <tr>
                        <td class="col-index">@((i + 1))</td>
                        <td class="col-title">@course.CourseCode.Title</td>
                        <td class="col-code">@course.CourseCode.Code</td>
                        <td class="col-units">@course.Unit</td>
                        <td class="col-prereq">@prereq</td>
                        <td class="col-semester">@s.Semester</td>
                        <td class="col-instructor @(instructor == null ? "no-instructor" : "")">
                            @(instructor != null ? $"{instructor.FirstName} {instructor.LastName}" : "استاد ندارد")
                        </td>
                        <td class="col-schedule">
                            @if (timeSlot != null)
                            {
                                <span>@timeSlot.Day</span><br />
                                <span>@timeSlot.StartTime.ToString(@"hh\:mm") - @timeSlot.EndTime.ToString(@"hh\:mm")</span>
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </td>
                        <td class="col-examdate">
                            @(course?.FinalExamDate != default(DateTime)
                                ? $"{pc.GetYear(course.FinalExamDate)}/{pc.GetMonth(course.FinalExamDate):00}/{pc.GetDayOfMonth(course.FinalExamDate):00}"
                                : "-")
                        </td>
                        <td class="col-description">@(string.IsNullOrWhiteSpace(course?.Description) ? "-" : course.Description)</td>

                        <!-- نمایش آیدی سکشن -->
                        <td class="col-courseid">
                            <button class="text-link copy-id-button"
                                    data-id="@s.Id"
                                    data-tooltip="@s.Id"
                                    data-tooltip-align="center">
                                کپی
                            </button>
                        </td>

                        <!-- دکمه‌ها با آیدی سکشن -->
                        <td class="col-actions">
                            <div class="actions-wrapper">
                                <a asp-controller="CourseManagement" asp-action="EditSection"
                                asp-route-id="@s.Id" asp-route-h="@currentHash"
                                class="btn-action btn-edit" data-tooltip="ویرایش سکشن" data-tooltip-align="center">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a asp-controller="CourseManagement" asp-action="DeleteSection"
                                asp-route-id="@s.Id" asp-route-h="@currentHash"
                                class="btn-action btn-delete" data-tooltip="حذف سکشن" data-tooltip-align="center">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        }
    </table>
</main>

<div class="empty-popup @(sections == null || !sections.Any() ? "will-show" : "")">
    <p>موردی جهت نمایش وجود ندارد</p>
</div>

@if (ViewBag.AnyWithoutInstructor == true)
{
    <div class="error-popup visible">
        <p>بعضی درس‌ها استاد ندارند، لطفاً استادشان را مشخص یا آن درس را حذف کنید.</p>
    </div>
}


@if (hasFooter)
{
    <footer class="dashboard-footer admin">
        <p>متن فوتر</p>
    </footer>
}

@section Scripts {
    <script src="~/js/Shared/tooltip.js"></script>
    <script>
        // فارسی‌سازی روزهای تایم‌اسلات در جدول
        document.addEventListener('DOMContentLoaded', function () {
            const dayMap = {
                'Saturday': 'شنبه',
                'Sunday': 'یکشنبه',
                'Monday': 'دوشنبه',
                'Tuesday': 'سه‌شنبه',
                'Wednesday': 'چهارشنبه',
                'Thursday': 'پنجشنبه',
                'Friday': 'جمعه'
            };

            document.querySelectorAll('.col-schedule span:first-child').forEach(span => {
                const originalText = span.textContent.trim();
                if (dayMap[originalText]) {
                    span.textContent = dayMap[originalText];
                }
            });
        });
        document.querySelectorAll('.copy-id-button').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-id');
                navigator.clipboard.writeText(id).then(() => {
                    const tooltip = document.querySelector('.custom-tooltip');
                    if (tooltip) {
                        tooltip.textContent = 'کپی شد!';
                        tooltip.classList.add('show');
                        const r = btn.getBoundingClientRect();
                        tooltip.style.top = (r.top - 30) + 'px';
                        tooltip.style.left = (r.left + r.width / 2 - tooltip.offsetWidth / 2) + 'px';
                        setTimeout(() => {
                            tooltip.classList.remove('show');
                        }, 2000);
                    }
                }).catch(err => {
                    console.error('خطا در کپی:', err);
                });
            });
        });
    </script>
}
